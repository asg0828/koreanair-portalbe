<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cdp.portal.app.facade.notice.mapper.NoticeMapper">

    <select id="selectNoticeList" resultType="NoticeResDto">
        SELECT
        *
        FROM (
        SELECT
        row_number() over(order by TBN.important_yn desc, TBN.rgst_dt desc) as rownum
        , TBN.NOTICE_ID		AS NOTICE_ID
        , TBN.SJ			AS SJ
        , TBN.CN			AS CN
        , TBN.IMPORTANT_YN  AS IMPORTANT_YN
        , (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'IMPORTANT_YN' AND CODE_ID = TBN.important_yn) AS IMPORTANT_YN_NM
        , TBN.ORD_SEQ		AS ORD_SEQ
        , TBN.USE_YN		AS USE_YN
        , (CASE TBN.USE_YN WHEN 'Y' THEN '게시' ELSE '미게시' END) AS USE_YN_NM
        <!-- , (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'USE_YN' AND CODE_ID = TBN.USE_YN) AS USE_YN_NM -->
        , TBN.RGST_ID		AS RGST_ID
        , TBN.RGST_DT		AS RGST_DT
        , TBN.MODI_ID		AS MODI_ID
        , TBN.MODI_DT		AS MODI_DT
        , TBN.VIEW_CNT		AS VIEW_CNT
        , tu.user_nm 		AS RGST_NM
        , (select dept_nm from t_dept where dept_code = tu.dept_code) AS RGST_DEPT_NM
        , TBN.POPUP_YN		AS POPUP_YN
        , (CASE TBN.POPUP_YN WHEN 'Y' THEN '사용' ELSE '미사용' END) AS POPUP_YN_NM
        , TBN.START_DT		AS START_DT
        , TBN.END_DT		AS END_DT
        , TBN.Del_YN		AS Del_YN
        from
        T_BBS_NOTICE TBN
        LEFT OUTER JOIN T_USER tu ON TBN.RGST_ID = tu.user_id
        ) A
    </select>

    <select id="selectNoticeListCount" resultType="int">
        SELECT
        COUNT(*)
        FROM
        T_BBS_NOTICE A
    </select>

    <select id="selectNotice" resultType="noticeModel" parameterType="noticeModel">
        SELECT A.*
        FROM(
                SELECT
                    NOTICE_ID 	AS NOTICE_ID
                     , TBN.SJ			AS SJ
                     , TBN.CN			AS CN
                     , TBN.IMPORTANT_YN	AS IMPORTANT_YN
                     , TBN.ORD_SEQ		AS ORD_SEQ
                     , TBN.USE_YN		AS USE_YN
                     , (CASE TBN.USE_YN WHEN 'Y' THEN '게시' ELSE '미게시' END) AS USE_YN_NM
                     , TBN.RGST_ID		AS RGST_ID
                     , TBN.RGST_DT		AS RGST_DT
                     , TBN.MODI_ID		AS MODI_ID
                     , TBN.MODI_DT		AS MODI_DT
                     , TU.USER_NM    	AS RGST_NM
                     , (SELECT DEPT_NM FROM T_DEPT WHERE DEPT_CODE = TU.DEPT_CODE) AS RGST_DEPT_NM
                     , (SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'COMPANY_CODE' AND CODE_ID = TU.COMPANY_CODE) AS COMPANY_NM
                     , TBN.VIEW_CNT		AS VIEW_CNT
                     , TBN.POPUP_YN		AS POPUP_YN
                     , (CASE POPUP_YN WHEN 'Y' THEN '사용' ELSE '미사용' END) AS POPUP_YN_NM
                     , TBN.START_DT		AS START_DT
                     , TBN.END_DT		AS END_DT
                     , LEAD(TBN.NOTICE_ID) OVER (ORDER BY TBN.NOTICE_ID) AS NEXT_ID
                     , LEAD(TBN.SJ)		  OVER (ORDER BY TBN.NOTICE_ID) AS NEXT_SJ
                     , LAG(TBN.NOTICE_ID)  OVER (ORDER BY TBN.NOTICE_ID) AS PRE_ID
                     , LAG(TBN.SJ) 		  OVER (ORDER BY TBN.NOTICE_ID) AS PRE_SJ
                FROM
                    T_BBS_NOTICE TBN
                        LEFT OUTER JOIN T_USER TU ON TBN.RGST_ID = TU.USER_ID
                WHERE
                    DEL_YN = 'N'
            ) Ae
        WHERE
            A.NOTICE_ID = #{noticeId}

    </select>

    <insert id="insertNotice" parameterType="noticeReqDto">
        INSERT INTO
            T_BBS_NOTICE (
                           NOTICE_ID
                         , SJ
                         , CN
                         , IMPORTANT_YN
                         , ORD_SEQ
                         , USE_YN
                         , RGST_ID
                         , RGST_DT
                         , MODI_ID
                         , MODI_DT
                         , VIEW_CNT
                         , POPUP_YN
                         , START_DT
                         , END_DT
        ) VALUES (
                   #{noticeId}
                 , #{sj}
                 , #{cn}
                 , #{importantYn}
                 , #{ordSeq}
                 , #{useYn}
                 , #{rgstId}
                 , NOW()
                 , #{modiId}
                 , NOW()
                 , 0
                 , #{popupYn}
                 , to_timestamp(#{startDt}||' 00:00:00','YYYY-MM-DD HH24:MI:SS')
                 , to_timestamp(#{endDt}||' 23:59:59','YYYY-MM-DD HH24:MI:SS')
                 )
    </insert>

    <update id="updateNotice" parameterType="noticeModel">
        UPDATE
            T_BBS_NOTICE
        SET
            SJ = #{sj}
          , CN = #{cn}
          , IMPORTANT_YN = #{importantYn}
          , ORD_SEQ = #{ordSeq}
          , USE_YN = #{useYn}
          , MODI_ID = #{modiId}
          , MODI_DT = NOW()
          , POPUP_YN = #{popupYn}
          , START_DT = TO_TIMESTAMP(#{startDt}||' 00:00:00','YYYY-MM-DD HH24:MI:SS')
          , END_DT = TO_TIMESTAMP(#{endDt}||' 23:59:59','YYYY-MM-DD HH24:MI:SS')
        WHERE
            NOTICE_ID = #{noticeId}
    </update>

    <update id="deleteNotice" parameterType="noticeModel">
        UPDATE
            T_BBS_NOTICE
        set
            DEL_YN = 'Y'
          , MODI_ID = #{modiId}
          , MODI_DT = NOW()
        WHERE
            NOTICE_ID = #{noticeId}
    </update>

</mapper>

