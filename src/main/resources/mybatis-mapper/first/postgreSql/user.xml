<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdp.ap.app.user.mapper.UserMapper">
    
    <sql id="searchUser">
		<where>
			<if test="searchKey != '' and searchKey == 'ALL' and searchValue != ''">
				and (upper(u.user_id) like upper('%'||#{searchValue}||'%') 
				      or upper(u.user_nm) like upper('%'||#{searchValue}||'%') 				      
				      or upper(p.pstn_nm) like upper('%'||#{searchValue}||'%')
					  or upper(d.dept_nm) like upper('%'||#{searchValue}||'%')
					  or upper(r.rank_nm) like upper('%'||#{searchValue}||'%')
					  or upper(y.duty_nm) like upper('%'||#{searchValue}||'%')
				       )
			</if>
			<if test="searchKey != '' and searchKey == 'userId' and searchValue != ''">
				and (upper(u.user_id) like upper('%'||#{searchValue}||'%'))
			</if>			
			<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
				and (upper(u.user_nm) like upper('%'||#{searchValue}||'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'deptCode' and searchValue != ''">
				and (upper(u.dept_code) = upper(#{searchValue}))
			</if>
			<if test="searchKey != '' and searchKey == 'deptNm' and searchValue != ''">
				and (upper(d.dept_nm) like upper('%'||#{searchValue}||'%'))
			</if>			
			<if test="searchKey != '' and searchKey == 'pstnCode' and searchValue != ''">
				and (upper(u.pstn_code) = upper(#{searchValue}))
			</if>
			<if test="searchKey != '' and searchKey == 'pstnNm' and searchValue != ''">
				and (upper(p.pstn_nm) like upper('%'||#{searchValue}||'%'))
			</if>			
			<if test="searchKey != '' and searchKey == 'rankCode' and searchValue != ''">
				and (upper(u.rank_code) = upper(#{searchValue}))
			</if>
			<if test="searchKey != '' and searchKey == 'rankNm' and searchValue != ''">
				and (upper(k.rank_nm) like upper('%'||#{searchValue}||'%'))
			</if>
			
			<if test="searchKey != '' and searchKey == 'dutyCode' and searchValue != ''">
				and (upper(u.duty_code) = upper(#{searchValue}))
			</if>
			<if test="searchKey != '' and searchKey == 'dutyNm' and searchValue != ''">
				and (upper(y.duty_nm) like upper('%'||#{searchValue}||'%'))
			</if>
			
			<if test="searchUseYn != null and searchUseYn != ''">
				and u.use_yn = #{searchUseYn}
			</if>
			<if test="searchCompanyCode != null and searchCompanyCode != ''">
				and u.company_code = #{searchCompanyCode}
			</if>
			<if test="searchRoleCode != null and searchRoleCode != ''">
				and r.auth_id = #{searchRoleCode}
			</if>			
			 
		</where>
	</sql>
	
	<select id="selectUserListCount" resultType="int" parameterType="userCriteria">
		select
			row_number() over (order by a.rgst_dt desc) as rownum,
			u.user_id,
			u.user_nm,
			u.pstn_code,
			p.pstn_nm,
			u.dept_code,
			d.dept_nm,
			u.rank_code,
			k.rank_nm,
			u.duty_code,
			y.duty_nm,
			u.company_code,
			(select code_nm from t_code where group_id = 'COMPANY_CODE' and code_id = u.company_code) company_nm,
			u.adof_dept_code,
			ad.dept_nm as adof_dept_nm,
			r.auth_id,
			r.use_yn as auth_use_yn,
			a.auth_nm,
			u.use_yn,
			u.last_log_dt,
			u.start_dt,
			u.end_dt,
			'N' as expired_yn,
			u.rgst_id,
			u.rgst_dt,
			u.modi_id,
			u.modi_dt,
			u.file_url
		from
			t_user u
			left outer join t_pstn p on u.pstn_code = p.pstn_code
			left outer join t_dept d on u.dept_code = d.dept_code
			left outer join t_hdept h on u.hdept_code = h.hdept_code
			left outer join t_dept ad on u.adof_dept_code = ad.dept_code
			left outer join t_rank k on u.rank_code = k.rank_code
			left outer join t_duty y on u.duty_code = y.duty_code
			left outer join t_user_auth r on u.user_id = r.user_id
			left outer join t_user_sys_auth a on r.auth_id = a.auth_id
		<include refid="searchUser"></include> 
    </select>
	
    <select id="selectUserList" resultType="userModel" parameterType="userCriteria">
		select
			row_number() over (order by a.rgst_dt desc) as rownum,
			u.user_id,
			u.user_nm,
			u.pstn_code,
			p.pstn_nm,
			u.dept_code,
			d.dept_nm,
			u.rank_code,
			k.rank_nm,
			u.duty_code,
			y.duty_nm,
			u.company_code,
			(select code_nm from t_code where group_id = 'COMPANY_CODE' and code_id = u.company_code) company_nm,
			u.adof_dept_code,
			ad.dept_nm as adof_dept_nm,
			r.auth_id,
			r.use_yn as auth_use_yn,
			a.auth_nm,
			u.use_yn,
			u.last_log_dt,
			u.start_dt,
			u.end_dt,
			'N' as expired_yn,
			u.rgst_id,
			u.rgst_dt,
			u.modi_id,
			u.modi_dt,
			u.file_url
		from
			t_user u
			left outer join t_pstn p on u.pstn_code = p.pstn_code
			left outer join t_dept d on u.dept_code = d.dept_code
			left outer join t_hdept h on u.hdept_code = h.hdept_code
			left outer join t_dept ad on u.adof_dept_code = ad.dept_code
			left outer join t_rank k on u.rank_code = k.rank_code
			left outer join t_duty y on u.duty_code = y.duty_code
			left outer join t_user_auth r on u.user_id = r.user_id
			left outer join t_user_sys_auth a on r.auth_id = a.auth_id
		<include refid="searchUser"></include>
		<include refid="paging.pagingOffsetSQL" />
		
		 		
    </select>
    
    <select id="selectDeptUserCount" resultType="int" parameterType="userCriteria">
	    select    
	        count(*)
		from t_user a
			inner join  t_dept b on a.dept_code = b.dept_code
			left outer join t_rank c on a.rank_code = c.rank_code
			left outer join t_pstn d on a.pstn_code = d.pstn_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'deptCode' and searchValue != ''">
			and (upper(a.dept_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'deptNm' and searchValue != ''">
			and (upper(b.dept_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y' 		
	</select>
	
	<select id="selectDeptUser" resultType="userModel" parameterType="userCriteria">
	    select    
	        row_number() over (order by a.dept_code,a.rgst_dt desc ) as rownum
			, a.user_id					AS user_id
			, a.user_nm					AS user_nm
			, a.dept_code				AS dept_code
			, b.dept_nm					AS dept_nm
			, a.rank_code				AS rank_code
			, c.rank_nm					AS rank_nm
			, a.pstn_code				AS pstn_code
			, d.pstn_nm					AS pstn_nm
			, a.company_code			AS company_code
			, ( select code_nm from t_code where group_id = 'COMPANY_CODE' and code_id = a.company_code) AS company_nm
		from t_user a
			inner join  t_dept b on a.dept_code = b.dept_code
			left outer join t_rank c on a.rank_code = c.rank_code
			left outer join t_pstn d on a.pstn_code = d.pstn_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'deptCode' and searchValue != ''">
			and (upper(a.dept_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'deptNm' and searchValue != ''">
			and (upper(b.dept_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y'
		<include refid="paging.pagingOffsetSQL" />
	</select>
	
	<select id="selectPstnUserCount" resultType="int" parameterType="userCriteria">
		select    
	         count(*)
		from t_user a
			inner join  t_pstn b on a.pstn_code = b.pstn_code
			left outer join t_rank c on a.rank_code = c.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'pstnCode' and searchValue != ''">
			and (upper(a.pstn_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'pstnNm' and searchValue != ''">
			and (upper(b.pstn_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y' 
	</select>
	
	<select id="selectPstnUser" resultType="userModel" parameterType="userCriteria">
		select    
	        row_number() over (order by a.pstn_code, a.rgst_dt desc ) as rownum
			,a.user_id
			,a.user_nm
			,a.pstn_code
			,b.pstn_nm
			,c.rank_nm
		from t_user a
			inner join  t_pstn b on a.pstn_code = b.pstn_code
			left outer join t_rank c on a.rank_code = c.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'pstnCode' and searchValue != ''">
			and (upper(a.pstn_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'pstnNm' and searchValue != ''">
			and (upper(b.pstn_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y'		
		<include refid="paging.pagingOffsetSQL" />
	</select>
	
	<select id="selectRankUserCount" resultType="int" parameterType="userCriteria">
		select    
	         count(*)
		from t_user a
			inner join  t_rank b on a.rank_code = b.rank_code
			left outer join t_rank c on a.rank_code = c.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm)  like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'rankCode' and searchValue != ''">
			and (upper(a.rank_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'rankNm' and searchValue != ''">
			and (upper(b.rank_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y' 
	</select>
	
	<select id="selectRankUser" resultType="userModel" parameterType="userCriteria">
		select    
	        row_number() over (order by a.rank_code,a.rgst_dt desc ) as rownum
			,a.user_id
			,a.user_nm
			,a.rank_code
			,b.rank_nm
			,c.rank_nm
		from t_user a
			inner join  t_rank b on a.rank_code = b.rank_code
			left outer join t_rank c on a.rank_code = c.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'rankCode' and searchValue != ''">
			and (upper(a.rank_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'rankNm' and searchValue != ''">
			and (upper(b.rank_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y'
		<include refid="paging.pagingOffsetSQL" />
		
	</select>
	
	<select id="selectDutyUserCount" resultType="int" parameterType="userCriteria">
		select    
	        count(*)
		from t_user a
			inner join  t_duty b on a.duty_code = b.duty_code
			left outer join t_rank c on a.rank_code = c.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'dutyCode' and searchValue != ''">
			and (upper(a.duty_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'dutyNm' and searchValue != ''">
			and (upper(b.duty_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y'
	</select>
	
	<select id="selectDutyUser" resultType="userModel" parameterType="userCriteria">
		select    
	        row_number() over (order by a.duty_code, a.rgst_dt desc ) as rownum
			,a.user_id
			,a.user_nm
			,a.duty_code
			,b.duty_nm
			,c.rank_nm
		from t_user a
			inner join  t_duty b on a.duty_code = b.duty_code
			left outer join t_rank c on a.rank_code = c.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm)  like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'dutyCode' and searchValue != ''">
			and (upper(a.duty_code) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'dutyNm' and searchValue != ''">
			and (upper(b.duty_nm) like upper('%'||#{searchValue}||'%'))
		</if>	
		AND COALESCE(a.USE_YN,'N') = 'Y'
		<include refid="paging.pagingOffsetSQL" />
		
	</select>
    
    <select id="selectAuthUserCount" resultType="int" parameterType="userCriteria">
    	select    
	          count(*)
    	from t_user a 
		inner join  t_user_auth b on a.user_id = b.user_id
		inner join  t_user_sys_auth c on b.auth_id = c.auth_id
		left outer join t_rank d on a.rank_code = d.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'authId' and searchValue != ''">
			and (upper(b.auth_id) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'authNm' and searchValue != ''">
			and (upper(c.auth_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y'		 
    </select>
    
    <select id="selectAuthUser" resultType="userModel" parameterType="userCriteria">
    	select    
	        row_number() over (order by b.auth_id, a.rgst_dt desc ) as rownum
			,a.user_id
			,a.user_nm
			,b.auth_id
			,c.auth_nm
			,d.rank_nm
    	from t_user a 
		inner join  t_user_auth b on a.user_id = b.user_id
		inner join  t_user_sys_auth c on b.auth_id = c.auth_id
		left outer join t_rank d on a.rank_code = d.rank_code
		where 1=1
		<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
			and (upper(a.user_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		<if test="companyCode != null and companyCode != ''">
				and a.company_code = #{companyCode}
		</if>
		<if test="searchKey != '' and searchKey == 'authId' and searchValue != ''">
			and (upper(b.auth_id) = upper(#{searchValue}))
		</if>
		<if test="searchKey != '' and searchKey == 'authNm' and searchValue != ''">
			and (upper(c.auth_nm) like upper('%'||#{searchValue}||'%'))
		</if>
		AND COALESCE(a.USE_YN,'N') = 'Y'
		<include refid="paging.pagingOffsetSQL" />
		
    </select>
    
</mapper>