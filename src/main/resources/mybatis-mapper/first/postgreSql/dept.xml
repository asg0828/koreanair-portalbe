<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdp.ap.app.dept.mapper.DeptMapper">

<!-- 부서 분류 조회 -->
	<select id="selectDeptCl" parameterType="string" resultType="deptClModel">
WITH RECURSIVE R AS (
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , 0 AS LV
      , ARRAY[M.DEPT_CODE::TEXT] AS FULL_PATH_ID
      , ARRAY[M.DEPT_NM::TEXT] AS FULL_PATH_NM
      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')] AS FULL_ORD_SEQ
      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT] AS FULL_PATH_ORD
    FROM PTL.T_DEPT_CL M
    WHERE M.UP_DEPT_CODE = 'Top' AND M.USE_YN = 'Y'
    UNION ALL
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , R.LV + 1 AS LV
      , ARRAY_APPEND(R.FULL_PATH_ID,M.DEPT_CODE::TEXT) AS FULL_PATH_ID
      , ARRAY_APPEND(R.FULL_PATH_NM,M.DEPT_NM::TEXT) AS FULL_PATH_NM
      , ARRAY_APPEND(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ::TEXT,5,'0')) AS FULL_ORD_SEQ
      , ARRAY_APPEND(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT) AS FULL_PATH_ORD
    FROM R
    JOIN PTL.T_DEPT_CL M ON R.DEPT_CODE = M.UP_DEPT_CODE AND M.USE_YN = 'Y'
) SELECT
    DEPT_CODE, UP_DEPT_CODE, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT
  , LV
  , ARRAY_TO_JSON(FULL_PATH_ID) AS FULL_PATH_ID
  , ARRAY_TO_JSON(FULL_PATH_NM) AS FULL_PATH_NM
  , ARRAY_TO_JSON(FULL_ORD_SEQ) AS FULL_ORD_SEQ
  , ARRAY_TO_STRING(FULL_PATH_ORD,'-') AS FULL_PATH_ORD
FROM R
WHERE DEPT_CODE = #{deptCode}
ORDER BY FULL_PATH_ORD
	</select>

<!-- 부서 분류 목록 조회 -->
	<select id="selectDeptClList" resultType="deptClModel">
WITH RECURSIVE R AS (
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , 0 AS LV
      , ARRAY[M.DEPT_CODE::TEXT] AS FULL_PATH_ID
      , ARRAY[M.DEPT_NM::TEXT] AS FULL_PATH_NM
      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')] AS FULL_ORD_SEQ
      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT] AS FULL_PATH_ORD
    FROM PTL.T_DEPT_CL M
    WHERE M.UP_DEPT_CODE = 'Top' AND M.USE_YN = 'Y'
    UNION ALL
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , R.LV + 1 AS LV
      , ARRAY_APPEND(R.FULL_PATH_ID,M.DEPT_CODE::TEXT) AS FULL_PATH_ID
      , ARRAY_APPEND(R.FULL_PATH_NM,M.DEPT_NM::TEXT) AS FULL_PATH_NM
      , ARRAY_APPEND(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ::TEXT,5,'0')) AS FULL_ORD_SEQ
      , ARRAY_APPEND(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT) AS FULL_PATH_ORD
    FROM R
    JOIN PTL.T_DEPT_CL M ON R.DEPT_CODE = M.UP_DEPT_CODE AND M.USE_YN = 'Y'
) SELECT
    DEPT_CODE, UP_DEPT_CODE, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT
  , LV
  , ARRAY_TO_JSON(FULL_PATH_ID) AS FULL_PATH_ID
  , ARRAY_TO_JSON(FULL_PATH_NM) AS FULL_PATH_NM
  , ARRAY_TO_JSON(FULL_ORD_SEQ) AS FULL_ORD_SEQ
  , ARRAY_TO_STRING(FULL_PATH_ORD,'-') AS FULL_PATH_ORD
FROM R
ORDER BY FULL_PATH_ORD
	</select>

	<select id="selectDeptClSearchList" parameterType="deptClModel" resultType="deptClModel">
WITH RECURSIVE R AS (
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , 0 AS LV
      , ARRAY[M.DEPT_CODE::TEXT] AS FULL_PATH_ID
      , ARRAY[M.DEPT_NM::TEXT] AS FULL_PATH_NM
      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')] AS FULL_ORD_SEQ
      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT] AS FULL_PATH_ORD
    FROM PTL.T_DEPT_CL M
    WHERE M.UP_DEPT_CODE = 'Top' AND M.USE_YN = 'Y'    
    UNION ALL
    SELECT
        M.DEPT_CODE, M.UP_DEPT_CODE, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT
      , R.LV + 1 AS LV
      , ARRAY_APPEND(R.FULL_PATH_ID,M.DEPT_CODE::TEXT) AS FULL_PATH_ID
      , ARRAY_APPEND(R.FULL_PATH_NM,M.DEPT_NM::TEXT) AS FULL_PATH_NM
      , ARRAY_APPEND(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ::TEXT,5,'0')) AS FULL_ORD_SEQ
      , ARRAY_APPEND(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT) AS FULL_PATH_ORD
    FROM R
    JOIN PTL.T_DEPT_CL M ON R.DEPT_CODE = M.UP_DEPT_CODE AND M.USE_YN = 'Y'
    WHERE 1=1    
) SELECT
    DEPT_CODE, UP_DEPT_CODE, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT
  , LV
  , ARRAY_TO_STRING(FULL_PATH_ID,'-') AS FULL_PATH_ID
  , ARRAY_TO_JSON(FULL_PATH_NM) AS FULL_PATH_NM
  , ARRAY_TO_JSON(FULL_ORD_SEQ) AS FULL_ORD_SEQ
  , ARRAY_TO_STRING(FULL_PATH_ORD,'-') AS FULL_PATH_ORD
FROM R
WHERE 1=1
    <if test="deptNm != null and deptNm != ''">
    	AND UPPER(DEPT_NM) LIKE CONCAT('%',UPPER(#{deptNm}),'%') 
    </if>
    <if test="deptCode != null and deptCode != ''">
    	AND UPPER(DEPT_CODE) = UPPER(#{deptCode})
    </if>
ORDER BY FULL_PATH_ORD
	</select>
	
	<select id="selectDeptList" parameterType="deptClModel" resultType="deptClModel">
		WITH RECURSIVE R AS (
		    SELECT
		        M.DEPT_CODE, M.hdept_code, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT,M.COMPANY_CODE
		      , 0 AS LV
		      , ARRAY[M.DEPT_CODE::TEXT] AS FULL_PATH_ID
		      , ARRAY[M.DEPT_NM::TEXT] AS FULL_PATH_NM
		      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')] AS FULL_ORD_SEQ
		      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT] AS FULL_PATH_ORD
		    FROM PTL.T_DEPT M
		    WHERE M.hdept_code = 'Top' AND M.USE_YN = 'Y'
		    UNION ALL
		    SELECT
		        M.DEPT_CODE, M.hdept_code, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT,M.COMPANY_CODE
		      , R.LV + 1 AS LV
		      , ARRAY_APPEND(R.FULL_PATH_ID,M.DEPT_CODE::TEXT) AS FULL_PATH_ID
		      , ARRAY_APPEND(R.FULL_PATH_NM,M.DEPT_NM::TEXT) AS FULL_PATH_NM
		      , ARRAY_APPEND(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ::TEXT,5,'0')) AS FULL_ORD_SEQ
		      , ARRAY_APPEND(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT) AS FULL_PATH_ORD
		    FROM R
		    JOIN PTL.T_DEPT M ON R.DEPT_CODE = M.hdept_code AND M.USE_YN = 'Y'
		) SELECT
		    DEPT_CODE, hdept_code, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT,COMPANY_CODE
		  , LV
		  , ARRAY_TO_JSON(FULL_PATH_ID) AS FULL_PATH_ID
		  , ARRAY_TO_JSON(FULL_PATH_NM) AS FULL_PATH_NM
		  , ARRAY_TO_JSON(FULL_ORD_SEQ) AS FULL_ORD_SEQ
		  , ARRAY_TO_STRING(FULL_PATH_ORD,'-') AS FULL_PATH_ORD
		FROM R
		WHERE 1=1
			<if test="deptNm != null and deptNm != ''">
			        AND UPPER(R.DEPT_NM) LIKE '%' || UPPER(#{deptNm}) || '%'
			</if>			
			<if test="companyCode != null and companyCode != ''">
				AND R.COMPANY_CODE = #{companyCode}
			</if>
		ORDER BY FULL_PATH_ORD
	</select>
	
	<select id="selectList" parameterType="deptClModel" resultType="deptClModel">
		WITH RECURSIVE R AS (
		    SELECT
		        M.DEPT_CODE, M.hdept_code, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT,M.COMPANY_CODE
		      , 0 AS LV
		      , ARRAY[M.DEPT_CODE::TEXT] AS FULL_PATH_ID
		      , ARRAY[M.DEPT_NM::TEXT] AS FULL_PATH_NM
		      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')] AS FULL_ORD_SEQ
		      , ARRAY[LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT] AS FULL_PATH_ORD
		    FROM PTL.t_dept M
		    WHERE M.hdept_code  is null 
		    UNION ALL
		    SELECT
		        M.DEPT_CODE, M.hdept_code, M.DEPT_NM, M.ORD_SEQ, M.USE_YN, M.RGST_ID, M.RGST_DT, M.MODI_ID, M.MODI_DT,M.COMPANY_CODE
		      , R.LV + 1 AS LV
		      , ARRAY_APPEND(R.FULL_PATH_ID,M.DEPT_CODE::TEXT) AS FULL_PATH_ID
		      , ARRAY_APPEND(R.FULL_PATH_NM,M.DEPT_NM::TEXT) AS FULL_PATH_NM
		      , ARRAY_APPEND(R.FULL_ORD_SEQ,LPAD(M.ORD_SEQ::TEXT,5,'0')) AS FULL_ORD_SEQ
		      , ARRAY_APPEND(R.FULL_PATH_ORD,LPAD(M.ORD_SEQ::TEXT,5,'0')||M.DEPT_NM::TEXT) AS FULL_PATH_ORD
		    FROM R
		    JOIN PTL.t_dept M ON R.DEPT_CODE = M.hdept_code 
		) SELECT
		    DEPT_CODE, hdept_code as UP_DEPT_CODE, DEPT_NM, ORD_SEQ, USE_YN, RGST_ID, RGST_DT, MODI_ID, MODI_DT,COMPANY_CODE
		  , LV
		  , ARRAY_TO_JSON(FULL_PATH_ID) AS FULL_PATH_ID
		  , ARRAY_TO_JSON(FULL_PATH_NM) AS FULL_PATH_NM
		  , ARRAY_TO_JSON(FULL_ORD_SEQ) AS FULL_ORD_SEQ
		  , ARRAY_TO_STRING(FULL_PATH_ORD,'-') AS FULL_PATH_ORD
		FROM R
		WHERE 1=1
			<if test="deptNm != null and deptNm != ''">
			        AND UPPER(R.DEPT_NM) LIKE '%' || UPPER(#{deptNm}) || '%'
			</if>
			<if test="deptCode != null and deptCode != ''">
		    	AND UPPER(R.DEPT_CODE) = UPPER(#{deptCode})
		    </if>
			<if test="companyCode != null and companyCode != ''">
				AND R.COMPANY_CODE = #{companyCode}
			</if>
			
		ORDER BY FULL_PATH_ORD
	</select>
	
	<insert id="insert" parameterType="deptClModel">
		 insert into t_dept(
		    dept_code
			,dept_nm
			,hdept_code
			,ord_seq
			,use_yn
			,modi_se
			,company_code
			,rgst_id
			,rgst_dt
			,modi_id
			,modi_dt
		)values(
			#{deptCode}
			,#{deptNm}
			,#{upDeptCode}
			,#{ordSeq}
			,#{useYn}
			,#{modiSe}
			,#{companyCode}
			,#{rgstId}
			,now()
			,#{modiId}
			,now()
		)
	</insert>
	 
	<update id="update" parameterType="deptClModel">
		update t_dept SET
		   dept_nm =#{deptNm}
		  ,ord_seq = #{ordSeq}
		  , use_yn = #{useYn}		  
		  , modi_se = #{modiSe}
		  , modi_id = #{modiId}
		  , modi_dt = now()
		  <if test="upDeptCode != null and upDeptCode != ''">
		  , hdept_code = #{upDeptCode}
		  </if>
		WHERE dept_code = #{deptCode}
    </update>
    
    <delete id="delete" parameterType="deptClModel">
		delete from t_dept 
		where dept_code = #{deptCode}
    </delete>
    
    <delete id="deleteAll" parameterType="string" >
		delete from t_dept 
		where company_code=#{companyCode}
    </delete>
    
    <insert id="insertHist" parameterType="string" >
    	insert into t_dept_hist    	
    	select current_timestamp as hist_dt
			,dept_code
			,dept_nm
			,hdept_code
			,ord_seq
			,use_yn
			,modi_se
			,company_code
			,rgst_id
			,rgst_dt
			,modi_id
			,modi_dt
    	from t_dept
    	WHERE company_code=#{companyCode}
    </insert>
    
</mapper>