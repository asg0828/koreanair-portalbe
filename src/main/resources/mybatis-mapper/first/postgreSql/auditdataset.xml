<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdp.ap.app.audit.mapper.AuditDataSetMapper">

    <sql id="order">
        order by dataset_id DESC
    </sql>

    <sql id="searchDataSet">
        <where>
            <if test="searchKey != '' and searchKey != 'ALL'">
                AND UPPER(dataset_type) = UPPER(#{searchKey}) 
            </if>
            <if test="searchValue != null and searchValue != ''">
                <bind
                        name="searchValue"
                        value='@com.bdp.ap.common.EscapeHelper@escape(searchValue)'
                />
                AND UPPER(user_nm) LIKE CONCAT('%',UPPER(#{searchValue}),'%')
            </if>
            <if test="startDt != null and startDt != ''">
				AND TO_DATE(start_dt::text,'YYYY-MM-DD') >= TO_DATE(#{startDt},'YYYY-MM-DD')
			</if>
			<if test="endDt != null and endDt != ''">
				AND TO_DATE(#{endDt},'YYYY-MM-DD') >= TO_DATE(start_dt::text,'YYYY-MM-DD')
			</if>
        </where>
    </sql>

    <sql id="searchUsingTable">
        <where>
            dataset_id = #{datasetId}
        </where>
    </sql>

    <select id="selectDataSetCount" resultType="int" parameterType="com.bdp.ap.common.paging.Criteria">
        select count(*)
        from
            t_dataset_table
        <include refid="searchDataSet"></include>
    </select>

    <select id="selectUsingTableList" resultType="usingTableModel" parameterType="string">
        select
            table_id, 
            dataset_id, 
            company_cd,
            code_nm as company_nm,
            db_type, 
            job_type,
            table_name_kr, 
            table_name_en, 
            table_desc 
        from
            t_using_table u
                left join ptl.t_code c 
                on c.group_id = 'COMPANY_CODE' and u.company_cd = c.code_id
        <include refid="searchUsingTable"></include>
        <include refid="order"></include>
    </select>

    <select id="selectUsingTableCount" resultType="int" parameterType="com.bdp.ap.common.paging.Criteria">
        select count(*)
        from
            t_using_table
        <include refid="searchUsingTable"></include>
    </select>

</mapper>