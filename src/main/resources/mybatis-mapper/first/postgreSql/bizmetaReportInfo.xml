<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdp.ap.app.bizmeta.mapper.BizmetaReportInfoMapper">
    
	<sql id="order">
		ORDER BY z.rgst_dt DESC
	</sql> 
		
	<select id="selectReportInfoList" resultType="reportInfoModel" parameterType="bizmetaCriteria">
	 	 select row_number() over (order by z.rgst_dt desc) as rownum
	 	            ,z.rpt_inf_id 
					,z.rpt_cl 
			        ,z.rpt_cl_nm
			        ,z.rpt_nm 
			        ,z.topic_area 
			        ,z.topic_area_nm
			        ,z.us_cyc 
			        ,z.us_cyc_nm
			        ,z.reg_nm
			        ,z.rgst_dt
			        ,z.opn_yn
			from 
			(select distinct a.rpt_inf_id
			        ,a.rpt_cl 
			        ,cd1.code_nm  as rpt_cl_nm
			        ,a.rpt_nm 
			        ,a.topic_area 
			        ,cd2.code_nm  as topic_area_nm
			        ,a.us_cyc 
			        ,cd3.code_nm  as us_cyc_nm
			        ,c.user_nm as reg_nm
			        ,a.rgst_dt
			        ,cd4.code_nm  as opn_yn
			from t_rpt_inf a
			left outer join t_code cd1 
			    on cd1.group_id = 'REPORT_CLASS_CD'  /*보고서구분*/
			    and cd1.code_id= a.rpt_cl
			left outer join t_code cd2 
			    on cd2.group_id = 'TOPIC_AREA_CD'  /*주제영역*/
			    and cd2.code_id= a.topic_area
			left outer join t_code cd3 
			    on cd3.group_id = 'USE_CYCLE_CD'  /*활용주기*/
			    and cd3.code_id= a.us_cyc    
			left outer join t_manage_info b
				on b.mng_inf_se_id = a.rpt_inf_id 
				and COALESCE(b.del_yn,'N') = 'N'
			left outer join t_code cd4 
			    on cd4.group_id = 'OPEN_YN'  /*공개여부*/
			    and cd4.code_id= b.opn_yn    	
			left outer join t_user c 
			    on c.user_id = a.reg_id 
			 left outer join t_measure d   
			    on d.mes_se_id = a.rpt_inf_id 
			   and COALESCE(d.del_yn,'N') = 'N'     
			left outer join t_data_mart e	
				on e.dt_mrt_se_id = a.rpt_inf_id 
				and COALESCE(e.del_yn,'N') = 'N'
			where 1=1
			and COALESCE(a.del_yn,'N') = 'N'
			<if test="rptCl != null and !('').equals(rptCl)">
					and a.rpt_cl = #{rptCl}                    /*보고서구분*/
				</if>
				<if test="startDt != null and startDt != ''">
					AND TO_DATE(A.rgst_dt::text,'YYYY-MM-DD')  >= TO_DATE(#{startDt},'YYYY-MM-DD')    /*등록일*/
				</if>
				<if test="endDt != null and endDt != ''">
					AND TO_DATE(#{endDt},'YYYY-MM-DD') >= TO_DATE(A.rgst_dt::text,'YYYY-MM-DD')			/*등록일*/
				</if>
				<if test="opnYn != null and !('').equals(opnYn)">	
					and b.opn_yn =#{opnYn}                            /*공개여부*/
				</if>
				<if test="searchNm != null and !('').equals(searchNm)">
					<bind
							name="searchNm"
							value='@com.bdp.ap.common.EscapeHelper@escape(searchNm)'
					/>
					and (1!=1   
						<if test="rptNmChk != null and !('').equals(rptNmChk)">
							or UPPER(a.rpt_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*보고서명*/
						</if>
						<if test="topicAreaChk != null and !('').equals(topicAreaChk)">
							or UPPER(cd2.code_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )         /*주제영역*/
						</if>
						<if test="mainItmChk != null and !('').equals(mainItmChk)">
							or UPPER(d.mes_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )             /*주요항목=메져*/ 
						</if>
						<if test="datSrcChk != null and !('').equals(datSrcChk)">
							or UPPER(e.tbl_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*데이터원천*/ 
							or UPPER(e.tbl_id) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*데이터원천*/
						</if>
					)
				   </if>
				 
				)z   
		<include refid="order" />
		<include refid="paging.pagingOffsetSQL" />
	</select>
	
	<select id="selectReportInfoCount" resultType="int" parameterType="bizmetaCriteria">
		 select count(*)
				from 
				(select distinct a.rpt_inf_id
				        ,a.rpt_cl 
				        ,cd1.code_nm  as rpt_cl_nm
				        ,a.rpt_nm 
				        ,a.topic_area 
				        ,cd2.code_nm  as topic_area_nm
				        ,a.us_cyc 
				        ,cd3.code_nm  as us_cyc_nm
				        ,c.user_nm as reg_nm
				        ,a.rgst_dt
				        ,cd4.code_nm  as opn_yn
				from t_rpt_inf a
				left outer join t_code cd1 
				    on cd1.group_id = 'REPORT_CLASS_CD'  /*보고서구분*/
				    and cd1.code_id= a.rpt_cl
				left outer join t_code cd2 
				    on cd2.group_id = 'TOPIC_AREA_CD'  /*주제영역*/
				    and cd2.code_id= a.topic_area
				left outer join t_code cd3 
				    on cd3.group_id = 'USE_CYCLE_CD'  /*활용주기*/
				    and cd3.code_id= a.us_cyc    
				left outer join t_manage_info b
					on b.mng_inf_se_id = a.rpt_inf_id 
					and COALESCE(b.del_yn,'N') = 'N'
				left outer join t_code cd4 
				    on cd4.group_id = 'OPEN_YN'  /*공개여부*/
				    and cd4.code_id= b.opn_yn    			
				left outer join t_user c 
				    on c.user_id = a.reg_id 
				 left outer join t_measure d   
			    on d.mes_se_id = a.rpt_inf_id 
			    and COALESCE(d.del_yn,'N') = 'N'     
				left outer join t_data_mart e	
					on e.dt_mrt_se_id = a.rpt_inf_id 
					and COALESCE(e.del_yn,'N') = 'N'
				where 1=1
				and COALESCE(a.del_yn,'N') = 'N'
				<if test="rptCl != null and !('').equals(rptCl)">
					and a.rpt_cl = #{rptCl}                    /*보고서구분*/
				</if>
				<if test="startDt != null and startDt != ''">
					AND TO_DATE(A.rgst_dt::text,'YYYY-MM-DD')  >= TO_DATE(#{startDt},'YYYY-MM-DD')    /*등록일*/
				</if>
				<if test="endDt != null and endDt != ''">
					AND TO_DATE(#{endDt},'YYYY-MM-DD') >= TO_DATE(A.rgst_dt::text,'YYYY-MM-DD')			/*등록일*/
				</if>
				<if test="opnYn != null and !('').equals(opnYn)">	
					and b.opn_yn =#{opnYn}                            /*공개여부*/
				</if>
				<if test="rptCd != null and !('').equals(rptCd)">	
					and a.rpt_cd =#{rptCd}                           
				</if>
				<if test="searchNm != null and !('').equals(searchNm)">
					<bind
							name="searchNm"
							value='@com.bdp.ap.common.EscapeHelper@escape(searchNm)'
					/>
					and (1!=1   
					<if test="rptNmChk != null and !('').equals(rptNmChk)">
						or UPPER(a.rpt_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*보고서명*/
					</if>
					<if test="topicAreaChk != null and !('').equals(topicAreaChk)">
						or UPPER(cd2.code_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )         /*주제영역*/
					</if>
				    <if test="mainItmChk != null and !('').equals(mainItmChk)">
				   		or UPPER(d.mes_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )             /*주요항목=메져*/ 
					</if>
				    <if test="datSrcChk != null and !('').equals(datSrcChk)">
				   		or UPPER(e.tbl_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*데이터원천*/ 
						or UPPER(e.tbl_id) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*데이터원천*/
					</if>
						)
				  </if>				  
				)z  
	</select>
	
	<select id="selectReportInfoExcel" resultType="reportInfoModel" parameterType="bizmetaCriteria">
	 	select row_number() over (order by z.rgst_dt desc) as row_num
						,z.rpt_cl 
				        ,z.rpt_cl_nm
				        ,z.rpt_nm 
				        ,z.topic_area 
				        ,z.topic_area_nm
				        ,z.us_cyc 
				        ,z.us_cyc_nm
				        ,z.reg_nm
				        ,z.rgst_dt
				        ,z.opn_yn
				from 
				(select distinct a.rpt_inf_id
				        ,a.rpt_cl 
				        ,cd1.code_nm  as rpt_cl_nm
				        ,a.rpt_nm 
				        ,a.topic_area 
				        ,cd2.code_nm  as topic_area_nm
				        ,a.us_cyc 
				        ,cd3.code_nm  as us_cyc_nm
				        ,c.user_nm as reg_nm
				        ,a.rgst_dt
				        ,cd4.code_nm  as opn_yn
				from t_rpt_inf a
				left outer join t_code cd1 
				    on cd1.group_id = 'REPORT_CLASS_CD'  /*보고서구분*/
				    and cd1.code_id= a.rpt_cl
				left outer join t_code cd2 
				    on cd2.group_id = 'TOPIC_AREA_CD'  /*주제영역*/
				    and cd2.code_id= a.topic_area
				left outer join t_code cd3 
				    on cd3.group_id = 'USE_CYCLE_CD'  /*활용주기*/
				    and cd3.code_id= a.us_cyc    
				left outer join t_manage_info b
					on b.mng_inf_se_id = a.rpt_inf_id 
					and COALESCE(b.del_yn,'N') = 'N'
				left outer join t_code cd4 
				    on cd4.group_id = 'OPEN_YN'  /*공개여부*/
				    and cd4.code_id= b.opn_yn    		
				left outer join t_user c 
				    on c.user_id = a.reg_id 
				left outer join t_data_mart e	
					on e.dt_mrt_se_id = a.rpt_inf_id 
					and COALESCE(e.del_yn,'N') = 'N'
				where 1=1
				and COALESCE(a.del_yn,'N') = 'N'
				<if test="rptCl != null and !('').equals(rptCl)">
					and a.rpt_cl = #{rptCl}                    /*보고서구분*/
				</if>
				<if test="startDt != null and startDt != ''">
					AND TO_DATE(A.rgst_dt::text,'YYYY-MM-DD')  >= TO_DATE(#{startDt},'YYYY-MM-DD')    /*등록일*/
				</if>
				<if test="endDt != null and endDt != ''">
					AND TO_DATE(#{endDt},'YYYY-MM-DD') >= TO_DATE(A.rgst_dt::text,'YYYY-MM-DD')			/*등록일*/
				</if>
				<if test="opnYn != null and !('').equals(opnYn)">	
					and b.opn_yn =#{opnYn}                            /*공개여부*/
				</if>
				<if test="searchNm != null and !('').equals(searchNm)">
					<bind
							name="searchNm"
							value='@com.bdp.ap.common.EscapeHelper@escape(searchNm)'
					/>
					and (1!=1   
					<if test="rptNmChk != null and !('').equals(rptNmChk)">
						or UPPER(a.rpt_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*보고서명*/
					</if>
					<if test="topicAreaChk != null and !('').equals(topicAreaChk)">
						or UPPER(cd2.code_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )         /*주제영역*/
					</if>
				    <if test="mainItmChk != null and !('').equals(mainItmChk)">
				   		or UPPER(d.mes_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )             /*주요항목=메져*/ 
					</if>
				    <if test="datSrcChk != null and !('').equals(datSrcChk)">
				   		or UPPER(e.tbl_nm) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*데이터원천*/ 
						or UPPER(e.tbl_id) like CONCAT('%',UPPER(#{searchNm}),'%' )                /*데이터원천*/
					</if>
					  )
				   </if>
				  ) z  
		<include refid="order" /> 
	</select>
	
	<insert id="insertReportInfo" parameterType="reportInfoModel">
		 insert into t_rpt_inf(
			rpt_inf_id
			,rpt_cl
			,rpt_cd
			,rpt_nm
			,topic_area
			,def
			,us_dtl
			,us_cyc
			,reg_id
			,del_yn
			,rgst_dt
			,rgst_id
			,modi_dt
			,modi_id
			,anlz_mrt_id
		)values(
		    #{rptInfId}
			,#{rptCl}
			,#{rptCd}
			,#{rptNm}
			,#{topicArea}
			,#{def}
			,#{usDtl}
			,#{usCyc}
			,#{regId}
			,#{delYn}
			,now()
			,#{rgstId}
			,now()
			,#{modiId}
			,#{anlzMrtId}
		)
	</insert>
	
	<select id="selectReportInfoDetail" resultType="reportInfoModel" parameterType="bizmetaCriteria">
		 select a.rpt_inf_id
		            ,a.rpt_cl
			        ,cd1.code_nm  as rpt_cl_nm
			        ,a.rpt_cd
			        ,a.rpt_nm 
			        ,a.topic_area
			        ,cd2.code_nm  as topic_area_nm
			        ,a.def 
			        ,a.us_dtl 
			        ,(select array_to_string(array_agg(tmc.col_nm), ',')
						from t_dimension s1
						inner join t_meta_col tmc
						on tmc.co_id = s1.dim_nm
						where s1.dim_se_id = a.rpt_inf_id
						and COALESCE(s1.del_yn,'N') = 'N'
						) as dim_nm
					,cd3.code_nm  as us_cyc_nm
					,(select array_to_string(array_agg(tmc.col_nm), ',')
						from t_measure s1
						inner join t_meta_col tmc
						on tmc.co_id = s1.mes_nm
						where s1.mes_se_id = a.rpt_inf_id 
						and COALESCE(s1.del_yn,'N') = 'N'
						) as mes_nm
					,(select array_to_string(array_agg(s1.tbl_id||'('||s1.tbl_nm||')'), ',')
						from t_data_mart s1
						where s1.dt_mrt_se_id = a.rpt_inf_id 
						and COALESCE(s1.del_yn,'N') = 'N'
						) as data_nm
					,(select array_to_string(array_agg(s1.fnd_tag_nm), ',')
						from t_find_tag s1
						where s1.fnd_tag_id = a.rpt_inf_id
						and COALESCE(s1.del_yn,'N') = 'N'
						) as fnd_tag_nm
					,(select s1.user_nm
					 from t_user s1
					 where s1.user_id = a.reg_id
					 )as mng_user_nm
			        ,(select array_to_string(array_agg(s2.dept_nm), ',')
							from t_mng_dept s1
							left outer join t_dept s2
							on s1.dept_cd = s2.dept_code 
							where s1.mng_dept_se_id = a.rpt_inf_id
							and s1.dept_se ='01' /*관리부서*/
							and COALESCE(s1.del_yn,'N') = 'N'
							) as dept_nm
					,(select array_to_string(array_agg(s2.dept_nm), ',')
							from t_mng_dept s1
							left outer join t_dept s2
							on s1.dept_cd = s2.dept_code 
							where s1.mng_dept_se_id = a.rpt_inf_id
							and s1.dept_se ='02' /*기피부서*/
							and COALESCE(s1.del_yn,'N') = 'N'
							) as avoid_dept_nm		
			        ,a.rgst_dt
				    ,a.modi_dt	
				    ,b.app_opin 
				    ,b.opn_yn
				    ,cd4.code_nm  as opn_yn_nm 
				    ,a.us_cyc
					, a.anlz_mrt_id		as anlz_mrt_id
					, tam.tbl_id		as anlz_mrt_tbl_id
					, tam.mart_nm		as mart_nm
			from t_rpt_inf a
			left outer join t_code cd1 
			    on cd1.group_id = 'REPORT_CLASS_CD'  /*보고서구분*/
			    and cd1.code_id= a.rpt_cl
			left outer join t_code cd2 
			    on cd2.group_id = 'TOPIC_AREA_CD'  /*주제영역*/
			    and cd2.code_id= a.topic_area
			left outer join t_code cd3 
			    on cd3.group_id = 'USE_CYCLE_CD'  /*활용주기*/
			    and cd3.code_id= a.us_cyc  
			left outer join t_manage_info b 
				on b.mng_inf_se_id = a.rpt_inf_id
				and COALESCE(b.del_yn,'N') = 'N'
			left outer join t_code cd4 
			on cd4.group_id = 'OPEN_YN' /*공개여부*/ 
			and cd4.code_id= b.opn_yn	
			left outer join t_anlz_mart tam 
			on a.anlz_mrt_id = tam.anlz_mrt_id
			where 1=1
			and a.rpt_inf_id = #{rptInfId}
	</select>
	
	<update id="updateReportInfo" parameterType="reportInfoModel">
		 update t_rpt_inf set rpt_cl = #{rptCl}
				,rpt_cd = #{rptCd}
				,rpt_nm = #{rptNm}
				,topic_area = #{topicArea}
				,def = #{def}
				,us_dtl = #{usDtl}
				,us_cyc = #{usCyc}
				,modi_dt=now()
				,modi_id=#{modiId}
				,anlz_mrt_id=#{anlzMrtId}
			where rpt_inf_id = #{rptInfId}
	</update>
	
	<update id="deleteReportInfo" parameterType="reportInfoModel">
			 update t_rpt_inf set del_yn = 'Y'
						,modi_dt = now()
						,modi_id = #{modiId} 
			where rpt_inf_id = #{rptInfId}			
	</update>
	
	 
	 
</mapper>