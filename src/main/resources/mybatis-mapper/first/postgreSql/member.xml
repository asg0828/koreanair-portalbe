<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdp.ap.app.member.mapper.MemberMapper">

	<sql id="searchMember">
		<where>
			<if test="searchValue != ''">
				<bind
						name="searchValue"
						value='@com.bdp.ap.common.EscapeHelper@escape(searchValue)'
				/>
			</if>
			<if test="searchKey != '' and searchKey == 'ALL' and searchValue != ''">
				and (upper(u.user_id) like upper('%'||#{searchValue}||'%') or upper(u.user_nm) like upper('%'||#{searchValue}||'%')) or (upper(d.dept_nm) like upper('%'||#{searchValue}||'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'userId' and searchValue != ''">
				and (upper(u.user_id) like upper('%'||#{searchValue}||'%'))
			</if>
			<if test="userNm != '' and userNm != null" >
				<bind
						name="userNm"
						value='@com.bdp.ap.common.EscapeHelper@escape(userNm)'
				/>
				and (upper(u.user_nm) like upper('%'||#{userNm}||'%'))
			</if>
			<if test="deptNm != '' and deptNm != null">
				<bind
						name="deptNm"
						value='@com.bdp.ap.common.EscapeHelper@escape(deptNm)'
				/>
				and (upper(d.dept_nm) like upper('%'||#{deptNm}||'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'userNm' and searchValue != ''">
				and (upper(u.user_nm) like upper('%'||#{searchValue}||'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'deptNm' and searchValue != ''">
				and (upper(d.dept_nm) like upper('%'||#{searchValue}||'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'deptCode' and searchValue != ''">
				and (upper(u.dept_code) = upper(#{searchValue}))
			</if>
			<if test="searchUseYn != null and searchUseYn != ''">
				and u.use_yn = #{searchUseYn}
			</if>
			<if test="searchCompanyCode != null and searchCompanyCode != ''">
				and u.company_code = #{searchCompanyCode}
			</if>
			<if test="searchRoleCode != null and searchRoleCode != ''">
				and r.auth_id = #{searchRoleCode}
			</if>			
			<if test="deptCode != null and deptCode != ''">
				and (upper(u.dept_code) = upper(#{deptCode}))
			</if>
			<if test="mgrRoles != null and mgrRoles != ''">
				and tma.auth_id = #{mgrRoles}
			</if>
			<if test="roles != null and roles != ''">
				and r.auth_id = #{roles}
			</if>
			<if test="filterLockYn != null and filterLockYn != ''">
				<choose>
					<when test="filterLockYn == 'Y'.toString()">
					and	coalesce(last_log_dt, now()) + interval '3 month' <![CDATA[<=]]> now()
					</when>
					<when test="filterLockYn == 'N'.toString()">
					and	coalesce(last_log_dt, now()) + interval '3 month' <![CDATA[>]]> now()
					</when>
				</choose> 			
			</if>			
		</where>
	</sql>

	<sql id="order">
		order by u.rgst_dt desc
	</sql>

	<select id="selectMemberList" resultType="memberModel" parameterType="memberCriteria">
		select
			row_number() over () as rownum,
			u.user_id,
			u.user_nm,
			u.pstn_code,
			p.pstn_nm,
			u.dept_code,
			d.dept_nm,
			u.rank_code,
			k.rank_nm,
			u.duty_code,
			y.duty_nm,
			u.company_code,
			(select code_nm from t_code where group_id = 'COMPANY_CODE' and code_id = u.company_code) company_nm,
			u.adof_dept_code,
			ad.dept_nm as adof_dept_nm,
			r.auth_id,
			r.use_yn as auth_use_yn,
			a.auth_nm,
			u.use_yn,
			u.last_log_dt,
			case
			when coalesce(last_log_dt, now()) + interval '3 month' <![CDATA[>]]> now() then 'N'
			else 'Y' end as lock_yn,
			u.start_dt,
			u.end_dt,
			'N' as expired_yn,
			u.rgst_id,
			u.rgst_dt,
			u.modi_id,
			u.modi_dt,
			u.file_url,
			ttu.tableau_user_id,
			COALESCE(tma.USE_YN,'N') AS MGR_YN,
			msa.AUTH_ID AS MGR_AUTH_ID,
			msa.AUTH_NM AS MGR_AUTH_NM
		from
			t_user u
			left outer join t_pstn p on u.pstn_code = p.pstn_code
			left outer join t_dept d on u.dept_code = d.dept_code
			left outer join t_hdept h on u.hdept_code = h.hdept_code
			left outer join t_dept ad on u.adof_dept_code = ad.dept_code
			left outer join t_rank k on u.rank_code = k.rank_code
			left outer join t_duty y on u.duty_code = y.duty_code
			left outer join t_user_auth r on u.user_id = r.user_id
			left outer join t_user_sys_auth a on r.auth_id = a.auth_id
			left outer join t_tableau_user ttu on u.user_id = ttu.user_id and ttu.use_yn = 'Y'
			left outer join t_mgr_auth tma on u.user_id = tma.user_id
			left outer join t_mgr_sys_auth msa on tma.auth_id = msa.auth_id
		<include refid="searchMember"></include>
		<include refid="order"></include>
		<include refid="paging.pagingOffsetSQL" />
	</select>

	<select id="selectMemberListCount" resultType="int" parameterType="memberCriteria">
		select
			count(*)
		from
			t_user u
			left outer join t_pstn p on u.pstn_code = p.pstn_code
			left outer join t_dept d on u.dept_code = d.dept_code
			left outer join t_hdept h on u.hdept_code = h.hdept_code
			left outer join t_dept ad on u.adof_dept_code = ad.dept_code
			left outer join t_rank k on u.rank_code = k.rank_code
			left outer join t_duty y on u.duty_code = y.duty_code
			left outer join t_user_auth r on u.user_id = r.user_id
			left outer join t_user_sys_auth a on r.auth_id = a.auth_id
			left outer join t_tableau_user ttu on u.user_id = ttu.user_id and ttu.use_yn = 'Y'
			left outer join t_mgr_auth tma on u.user_id = tma.user_id
			left outer join t_mgr_sys_auth msa on tma.auth_id = msa.auth_id
		<include refid="searchMember"></include>
	</select>

	<select id="selectMemberAllList" resultType="memberModel" parameterType="memberCriteria">
		select
			row_number() over () as rownum,
			u.user_id,
			u.user_nm,
			u.pstn_code,
			p.pstn_nm,
			u.dept_code,
			d.dept_nm,
			u.rank_code,
			k.rank_nm,
			u.duty_code,
			y.duty_nm,
			u.company_code,
			(select code_nm from t_code where group_id = 'COMPANY_CODE' and code_id = u.company_code) company_nm,
			u.adof_dept_code,
			ad.dept_nm as adof_dept_nm,
			r.auth_id,
			r.use_yn as auth_use_yn,
			a.auth_nm,
			u.use_yn,
			u.last_log_dt,
			case
			when coalesce(last_log_dt, now()) + interval '3 month' <![CDATA[>]]> now() then 'Y'
			else 'N' end as lock_yn,
			u.start_dt,
			u.end_dt,
			'N' as expired_yn,
			u.rgst_id,
			u.rgst_dt,
			u.modi_id,
			u.modi_dt,
			u.file_url,
			ttu.tableau_user_id,
			COALESCE(tma.USE_YN,'N') AS MGR_YN,
			msa.AUTH_ID AS MGR_AUTH_ID,
			msa.AUTH_NM AS MGR_AUTH_NM
		from
			t_user u
			left outer join t_pstn p on u.pstn_code = p.pstn_code
			left outer join t_dept d on u.dept_code = d.dept_code
			left outer join t_hdept h on u.hdept_code = h.hdept_code
			left outer join t_dept ad on u.adof_dept_code = ad.dept_code
			left outer join t_rank k on u.rank_code = k.rank_code
			left outer join t_duty y on u.duty_code = y.duty_code
			left outer join t_user_auth r on u.user_id = r.user_id
			left outer join t_user_sys_auth a on r.auth_id = a.auth_id
			left outer join t_tableau_user ttu on u.user_id = ttu.user_id and ttu.use_yn = 'Y'
			left outer join t_mgr_auth tma on u.user_id = tma.user_id
			left outer join t_mgr_sys_auth msa on tma.auth_id = msa.auth_id
		<include refid="searchMember"></include>
		ORDER BY U.USER_NM
	</select>
	
	<select id="selectMember" parameterType="memberModel" resultType="memberModel">
		select 
			u.user_id,
			u.user_nm,
			u.pstn_code,
			p.pstn_nm,
			u.dept_code,
			d.dept_nm,
			u.rank_code,
			k.rank_nm,
			u.duty_code,
			y.duty_nm,
			u.company_code,
			(select code_nm from t_code where group_id = 'COMPANY_CODE' and code_id = u.company_code) company_nm,
			u.adof_dept_code,
			ad.dept_nm as adof_dept_nm,
			r.auth_id,
			r.use_yn as auth_use_yn,
			a.auth_nm,
			u.use_yn,
			u.last_log_dt,
			u.start_dt,
			u.end_dt,
			'N' as expired_yn,
			u.rgst_id,
			u.rgst_dt,
			u.modi_id,
			u.modi_dt,
			ttu.tableau_user_id,
			COALESCE(tma.USE_YN,'N') AS MGR_YN,
			msa.AUTH_ID AS MGR_AUTH_ID,
			msa.AUTH_NM AS MGR_AUTH_NM,
			tuh.mgr_auth_nm as before_mgr_auth_nm,
			tuh.user_auth_nm as before_auth_nm
		from
			t_user u
			left outer join t_pstn p on u.pstn_code = p.pstn_code
			left outer join t_dept d on u.dept_code = d.dept_code
			left outer join t_hdept h on u.hdept_code = h.hdept_code
			left outer join t_dept ad on u.adof_dept_code = ad.dept_code
			left outer join t_rank k on u.rank_code = k.rank_code
			left outer join t_duty y on u.duty_code = y.duty_code
			left outer join t_user_auth r on u.user_id = r.user_id
			left outer join t_user_sys_auth a on r.auth_id = a.auth_id
			left outer join t_tableau_user ttu on u.user_id = ttu.user_id and ttu.use_yn = 'Y'
			left outer join t_mgr_auth tma on u.user_id = tma.user_id
			left outer join t_mgr_sys_auth msa on tma.auth_id = msa.auth_id
			left outer join t_user_hist tuh on tuh.user_id = u.user_id and tuh.hist_dt = 
																		(select max(hist_dt)
																		from t_user_hist
																		where user_id = u.user_id )
		where
			u.user_id = #{userId}
	</select>

	<select id="selectMemberListCountForRoleId" resultType="int" parameterType="String">
		select
			count(*)
		from
			t_user_auth
		where
			auth_id = #{authId}
	</select>

	<insert id="upsertAuth" parameterType="memberModel">
		insert into t_user_auth (user_id, auth_id, use_yn, rgst_id, rgst_dt, modi_id, modi_dt)
		values (#{userId}, #{authId}, #{useYn}, #{rgstId}, now(), #{modiId}, now())
		on conflict (user_id) do update set
			use_yn = #{useYn}
		  , auth_id = #{authId}
		  , modi_dt = now()
		  , modi_id = #{modiId}
	</insert>

	<insert id="upsertMgrAuth" parameterType="memberModel">
		INSERT INTO T_MGR_AUTH (user_id, auth_id, use_yn, rgst_id, rgst_dt, modi_id, modi_dt)
		values (#{userId}, #{authId}, #{useYn}, #{rgstId}, now(), #{modiId}, now())
		on conflict (user_id) do update set
			use_yn = #{useYn}
		  , auth_id = #{authId}
		  , modi_dt = now()
		  , modi_id = #{modiId}
	</insert>
	<insert id="insert" parameterType="memberModel">
		insert into t_user
			(user_id,
			user_nm,
			pstn_code,
			dept_code,
			hdept_code,
			adof_dept_code,
			rank_code,
			duty_code,
			company_code,
			duty_se,
			last_log_dt,
			start_dt,
			end_dt,
			file_url,
			mgr_sys_env,
			user_sys_home,
			user_sys_env,
			bf_dept_code,
			use_yn,
			modi_se,
			rgst_id,
			rgst_dt,
			modi_id,
			modi_dt)
		values
			(#{userId},
			#{userNm},
			#{pstnCode},
			#{deptCode},
			#{hdeptCode},
			null,
			#{rankCode},
			#{dutyCode},
			#{companyCode},
			'Y',
			now(),
			#{startDt},
			#{endDt},
			null,
			null,
			null,
			null,
			null,
			'Y',
			'R',
			#{rgstId},
			now(),
			#{rgstId},
			now())
	</insert>
	 <update id="update" parameterType="memberModel">
		update t_user
		set
			use_yn = #{useYn}
		  , user_nm = #{userNm}
		  , pstn_code = #{pstnCode}
		  , dept_code = #{deptCode}
		  , rank_code = #{rankCode}
		  , duty_code = #{dutyCode}
		  , company_code = #{companyCode}
		  , start_dt = #{startDt}
		  , end_dt = #{endDt}
		  , modi_dt = now()
		  , modi_id = #{modiId}
		where
			user_id = #{userId}
	</update>
	
	 <insert id="insertUserHst" parameterType="memberModel">
		insert into t_user_hist 
			select 
			current_timestamp hist_dt,
			tu.user_id,
			tu.user_nm,
			tu.pstn_code,
			(select tp.pstn_nm from t_pstn tp where tp.pstn_code = tu.pstn_code) pstn_nm,
			tu.dept_code,
			(select td.dept_nm from t_dept td where td.dept_code = tu.dept_code) dept_nm,	
			tu.rank_code,
			(select tp.rank_nm from t_rank tp where tp.rank_code = tu.rank_code) rank_nm,
			tu.duty_code,
			(select tp.duty_nm from t_duty tp where tp.duty_code = tu.duty_code) duty_nm,
			tu.company_code,
			(select tc.code_nm from t_code tc where tc.group_id = 'COMPANY_CODE' and tc.code_id = tu.company_code) company_nm,
			tu.duty_se,
			tu.last_log_dt,
			tu.start_dt,
			tu.end_dt,
			tu.file_url ,
			ma.auth_id,
			tma.auth_nm,
		    ua.auth_id, 
			tua.auth_nm ,
			tu.use_yn ,
			tu.modi_se ,
			tu.rgst_id,
			tu.rgst_dt,
			tu.modi_id,
			tu.modi_dt	
		from 
			t_user tu, 
			t_user_sys_auth tua,
			t_user_auth ua,
			t_mgr_sys_auth tma,
			t_mgr_auth ma
		where 
			tu.user_id = #{userId}
			and tu.user_id = ua.user_id
			and ua.auth_id = tua.auth_id 
			and tu.user_id = ma.user_id 
			and ma.auth_id  = tma.auth_id  
	</insert>	
	
	<select id="selectMemberListCountForMgrRoleId" resultType="int" parameterType="String">
		SELECT
			COUNT(1) AS CNT
		FROM
			T_MGR_AUTH
		WHERE
			AUTH_ID = #{authId}
	</select>
	
	<insert id="insertMgrAuth" parameterType="memberModel">
		INSER INTO T_MGR_AUTH(
    		  USER_ID
    		, AUTH_ID
    		, USE_YN
    		, RGST_ID
			, RGST_DT
			, MODI_ID
			, MODI_DT
    	)VALUES(
    		#{userId}
    		, #{authId}
    		, #{useYn}
    		, #{rgstId}
    		, NOW()
    		, #{modiId}
    		, NOW()
    	)
	</insert>
	<update id="updateMgrAuth" parameterType="memberModel">
		UPDATE T_MGR_AUTH
        SET
			  AUTH_ID = #{authId}
            , USE_YN = #{useYn}
            , MODI_ID = #{modiId}
            , MODI_DT = now()
        WHERE
            USER_ID = #{userId}
	</update>

	<delete id="deleteMgrAuth" parameterType="memberModel">
		UPDATE T_MGR_AUTH
        SET
            USE_YN = 'N'
        WHERE USER_ID = #{userId}
	</delete>
	
	<update id="unlockAccount" parameterType="memberModel">
		UPDATE t_user
        SET
            last_log_dt = NULL
        WHERE USER_ID = #{userId}
	</update>	

</mapper>