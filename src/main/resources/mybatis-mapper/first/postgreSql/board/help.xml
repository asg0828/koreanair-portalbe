<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdp.ap.app.board.mapper.HelpMapper">
	<sql id="where">
		<where>
			<if test="searchValue != '' ">
				<bind
						name="searchValue"
						value='@com.bdp.ap.common.EscapeHelper@escape(searchValue)'
				/>
			</if>
			<if test="searchKey != '' and searchKey == 'ALL' and searchValue != ''">
				AND (UPPER(sj) LIKE CONCAT('%',UPPER(#{searchValue}),'%') OR UPPER(cn) LIKE CONCAT('%',UPPER(#{searchValue}),'%'))
			</if>
			<if test="searchKey != '' and searchKey == 'sj' and searchValue != ''">
				AND UPPER(sj) LIKE CONCAT('%',UPPER(#{searchValue}),'%')
			</if>
			<if test="searchKey != '' and searchKey == 'cn' and searchValue != ''">
				AND UPPER(cn) LIKE CONCAT('%',UPPER(#{searchValue}),'%')
			</if>
				AND DEL_YN = 'N'			
		</where>
	</sql>
	
    <sql id="order">
        ORDER BY a.rownum ASC
    </sql> 	
 
	<select id="selectHelpList" resultType="helpModel" parameterType="criteria">
		select
			*
		from (
			select
				row_number() over(order by tbn.important_yn desc, tbn.rgst_dt desc) as rownum,
				tbn.help_id,
				tbn.sj,
				tbn.cn,
				tbn.important_yn,
				(case tbn.important_yn
					when 'Y' then '중요' 
					else '일반' 
				end) as important_yn_nm,
				tbn.use_yn,
				tbn.del_yn,
				(CASE tbn.USE_YN WHEN 'Y' THEN '게시' ELSE '미게시' END) AS USE_YN_NM,
				tbn.rgst_id,
				tbn.rgst_dt,
				tbn.modi_id,
				tbn.modi_dt,
				tbn.view_cnt,
				tu.user_nm as rgst_nm,
				(select dept_nm from t_dept where dept_code = tu.dept_code) as rgst_dept_nm,
				tbn.category_cd,
				tbn.group_cd
							
			from
				ptl.t_bbs_help tbn
				left outer join ptl.t_user tu on tbn.rgst_id = tu.user_id
		) a
        <include refid="where" />
        <include refid="order" />
        <include refid="paging.pagingOffsetSQL" />  
    </select> 
 
	<select id="selectHelpListCount" resultType="int" parameterType="criteria">
		SELECT
			COUNT(*)
		FROM 
			ptl.t_bbs_help
		<include refid="where" />
	</select>

	<select id="selectHelp" resultType="helpModel" parameterType="helpModel">
		SELECT A.*
		FROM (
			SELECT
				TBN.help_id,
				TBN.sj,
				TBN.cn,
				TBN.important_yn,
				(case TBN.important_yn
					when 'Y' then '중요' 
					else '일반' 
				end) as important_yn_nm,
				TBN.use_yn,
				(CASE TBN.USE_YN WHEN 'Y' THEN '게시' ELSE '미게시' END) AS USE_YN_NM,
				TBN.del_yn,
				TBN.rgst_id,
				TBN.rgst_dt,
				TBN.modi_id,
				TBN.modi_dt,
				TU.USER_NM     AS RGST_NM,
                (SELECT DEPT_NM FROM T_DEPT WHERE DEPT_CODE = TU.DEPT_CODE) AS RGST_DEPT_NM,
				TBN.view_cnt,
				TBN.category_cd,
				(SELECT CODE_NM FROM T_CODE WHERE GROUP_ID = 'CATEGORY_CD' AND CODE_ID = TBN.CATEGORY_CD) AS CATEGORY_CD_NM,
				TBN.group_cd,
				LEAD(TBN.help_id,1) OVER (
					ORDER BY TBN.help_id
				) next_id,
				LEAD(TBN.sj,1) OVER (
					ORDER BY TBN.help_id
				) next_sj,
				lag(TBN.help_id,1) OVER (
					ORDER BY TBN.help_id
				) pre_id,
				lag(TBN.sj,1) OVER (
					ORDER BY TBN.help_id
				) pre_sj
			FROM 
				ptl.t_bbs_help TBN
				LEFT OUTER JOIN T_USER TU ON TBN.RGST_ID = TU.USER_ID
			WHERE
				del_yn = 'N'
			) A
		WHERE
			A.help_id = #{helpId}

	</select>
	
	<insert id="insertHelp" parameterType="helpModel">
		INSERT INTO ptl.t_bbs_help (
			help_id,
			sj,
			cn,
			important_yn,
			use_yn,
			rgst_id,
			rgst_dt,
			modi_id,
			modi_dt,
			view_cnt,
			category_cd,
			group_cd		
		) VALUES (
			#{helpId},
			#{sj},
			#{cn},
			#{importantYn},
			'Y',
			#{rgstId},
			now(),
			#{modiId},
			now(),
			0,
			#{categoryCd},
			#{groupCd}
		)
	</insert>
	
	<update id="updateHelp" parameterType="helpModel">
		UPDATE
			ptl.t_bbs_help
		SET
			sj = #{sj},
			cn = #{cn},
			important_yn = #{importantYn},
			use_yn = #{useYn},
			modi_id = #{modiId},
			modi_dt = now(),
			category_cd = #{categoryCd},
			group_cd = #{groupCd}
	   WHERE
			help_id = #{helpId}
	</update>
	
	<update id="deleteHelp" parameterType="helpModel">
		UPDATE
			ptl.t_bbs_help
		set
			DEL_YN = 'Y',
			modi_id = #{modiId},
			modi_dt = now()
		WHERE
			help_id = #{helpId}
	</update>

	<update id="addViewCntHelp" parameterType="helpModel">
		UPDATE
			ptl.t_bbs_help
		set
			view_cnt = (coalesce(view_cnt, 0) + 1)
		WHERE
			help_id = #{helpId}
	</update> 	    
	
</mapper>